@model MasterDetailApp.ViewModels.OrderViewModel

@{
    ViewBag.Title = "Edit Order";
}

<h2>Edit Order</h2>

@using (Html.BeginForm("Edit", "Orders", FormMethod.Post, new { enctype = "multipart/form-data" }))
{
    @Html.AntiForgeryToken()
    @Html.HiddenFor(m => m.Order.Id)

    <div class="form-horizontal">
        <hr />
        <div class="form-group">
            @Html.LabelFor(m => m.Order.CustomerName, htmlAttributes: new { @class = "control-label" })
            @Html.TextBoxFor(m => m.Order.CustomerName, new { @class = "form-control" })
            @Html.ValidationMessageFor(m => m.Order.CustomerName, "", new { @class = "text-danger" })
        </div>

        <div class="form-group">
            @Html.LabelFor(m => m.Order.OrderDate, htmlAttributes: new { @class = "control-label" })
            @Html.TextBoxFor(m => m.Order.OrderDate, "{0:yyyy-MM-dd}", new { @class = "form-control", type = "date" })
            @Html.ValidationMessageFor(m => m.Order.OrderDate, "", new { @class = "text-danger" })
        </div>

        <div class="form-group">
            @Html.LabelFor(m => m.Order.IsPaid, htmlAttributes: new { @class = "control-label" })
            @Html.CheckBoxFor(m => m.Order.IsPaid)
        </div>

        <div class="form-group">
            @Html.Label("Current Image")
            @if (!string.IsNullOrEmpty(Model.Order.ImagePath))
            {
                <br />
                <img src="@Model.Order.ImagePath" width="100" />
            }
        </div>

        <div class="form-group">
            @Html.Label("Upload New Image", htmlAttributes: new { @class = "control-label" })
            <input type="file" name="imageFile" class="form-control" />
        </div>

        <h4>Order Items</h4>
        <table class="table table-bordered" id="itemsTable">
            <thead>
                <tr>
                    <th>Product</th>
                    <th>Quantity</th>
                    <th>Price</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @for (int i = 0; i < Model.Items.Count; i++)
                {
                    <tr>
                        @Html.HiddenFor(m => m.Items[i].Id)
                        <td>@Html.TextBoxFor(m => m.Items[i].ProductName, new { @class = "form-control" })</td>
                        <td>@Html.TextBoxFor(m => m.Items[i].Quantity, new { @class = "form-control", type = "number", min = 1 })</td>
                        <td>@Html.TextBoxFor(m => m.Items[i].Price, new { @class = "form-control", type = "number", step = "0.01" })</td>
                        <td>
                            <button type="button" class="btn btn-danger btn-sm remove-item">Remove</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>

        <button type="button" id="addItem" class="btn btn-secondary">Add Item</button>

        <div class="form-group mt-3">
            <input type="submit" value="Save" class="btn btn-primary" />
            @Html.ActionLink("Back to List", "Index", null, new { @class = "btn btn-default" })
        </div>
    </div>
}

@section scripts {
    <script>
        $(document).ready(function () {
            $('#addItem').click(function () {
                var index = $('#itemsTable tbody tr').length;
                var row = `
<tr>
    <td><input type="text" name="Items[${index}].ProductName" class="form-control" /></td>
    <td><input type="number" name="Items[${index}].Quantity" class="form-control" min="1" /></td>
    <td><input type="number" name="Items[${index}].Price" class="form-control" step="0.01" /></td>
    <td><button type="button" class="btn btn-danger btn-sm remove-item">Remove</button></td>
</tr>`;
                $('#itemsTable tbody').append(row);
            });

            $(document).on('click', '.remove-item', function () {
                $(this).closest('tr').remove();
            });
        });
    </script>
}
